<!DOCTYPE html>

<html>
<head>
  <title>zappa.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="client.html">
                client.coffee
              </a>
            
              
              <a class="source" href="zappa.html">
                zappa.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>zappa.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><strong>Zappa</strong> is a <a href="http://coffeescript.org">CoffeeScript</a> DSL-ish interface
for building web apps on the <a href="http://nodejs.org">node.js</a> runtime,
integrating <a href="http://expressjs.com">express</a>, <a href="http://socket.io">socket.io</a>
and other best-of-breed libraries.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
zappa = <span class="hljs-attribute">version</span>: (<span class="hljs-built_in">require</span> <span class="hljs-string">'../package.json'</span>).version

log = <span class="hljs-built_in">console</span>.log
fs = <span class="hljs-built_in">require</span> <span class="hljs-string">'fs'</span>
path = <span class="hljs-built_in">require</span> <span class="hljs-string">'path'</span>
uuid = <span class="hljs-built_in">require</span> <span class="hljs-string">'node-uuid'</span>
methods = <span class="hljs-built_in">require</span> <span class="hljs-string">'methods'</span>

session = <span class="hljs-built_in">require</span> <span class="hljs-string">'express-session'</span>
serveStatic = <span class="hljs-built_in">require</span> <span class="hljs-string">'serve-static'</span>
<span class="hljs-function">
<span class="hljs-title">vendor_module</span> = <span class="hljs-params">(<span class="hljs-built_in">module</span>,args...)</span> -&gt;</span>
  fs.readFileSync (path.join (path.dirname <span class="hljs-built_in">require</span>.resolve <span class="hljs-built_in">module</span>), args...), <span class="hljs-string">'utf-8'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Soft dependencies:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>uglify = <span class="hljs-literal">null</span>
coffee_css = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>CoffeeScript-generated JavaScript may contain anyone of these; when we
“rewrite” a function (see below) though, it loses access to its parent scope,
and consequently to any helpers it might need. So we need to reintroduce
these helpers manually inside any “rewritten” function.
This list is taken from coffeescript’s <code>src/nodes.coffee</code> UTILITIES.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>coffeescript_helpers = <span class="hljs-string">"""
  var __slice = [].slice;
  var __hasProp = {}.hasOwnProperty;
  var __bind = function(fn, me){
    return function(){ return fn.apply(me, arguments); };
  };
  var __extends = function(child, parent) {
    for (var key in parent) {
      if (__hasProp.call(parent, key)) child[key] = parent[key];
    }
    function ctor() { this.constructor = child; }
    ctor.prototype = parent.prototype;
    child.prototype = new ctor();
    child.__super__ = parent.prototype;
    return child;
  };
  var __indexOf = [].indexOf || function(item) {
    for (var i = 0, l = this.length; i &lt; l; i++) {
      if (i in this &amp;&amp; this[i] === item) return i;
    } return -1; };
  var __modulo = function(a, b) { return (+a % (b = +b) + b) % b; };
"""</span>.replace <span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">''</span>
<span class="hljs-function">
<span class="hljs-title">minify</span> = <span class="hljs-params">(js)</span> -&gt;</span>
  uglify ?= <span class="hljs-built_in">require</span> <span class="hljs-string">'uglify-js'</span>
  result = uglify.minify js, <span class="hljs-attribute">fromString</span>:<span class="hljs-literal">true</span>
  result.code</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Flatten array recursively (copied from Express’s utils.js)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">flatten</span> = <span class="hljs-params">(arr, ret)</span> -&gt;</span>
  ret ?= []
  <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> arr
    <span class="hljs-keyword">if</span> Array.isArray o
      flatten o, ret
    <span class="hljs-keyword">else</span>
      ret.push o
  ret</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Takes in a function and builds express/socket.io apps based on the rules
contained in it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>zappa.a<span class="hljs-function"><span class="hljs-title">pp</span> = -&gt;</span>
  <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> arguments
    <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'function'</span>
        func = a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
        options = a

  options ?= {}

  express = options.express ? <span class="hljs-built_in">require</span> <span class="hljs-string">'express'</span>

  context = {<span class="hljs-attribute">id</span>: uuid.v4(), zappa, express, session}

  root = path.dirname <span class="hljs-built_in">module</span>.parent.filename</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Storage for user-provided stuff.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ws_handlers = {}
  helpers = {}

  app = context.app = express()
  <span class="hljs-keyword">if</span> options.https?
    context.server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'https'</span>).createServer options.https, app
  <span class="hljs-keyword">else</span>
    context.server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>).createServer app</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Set options.io to false to disable socket.io.
Set options.io to socket.io’s parameters otherwise (optional).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  io = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">if</span> options.io <span class="hljs-keyword">isnt</span> <span class="hljs-literal">false</span>
    socketio = options.socketio ? <span class="hljs-built_in">require</span> <span class="hljs-string">'socket.io'</span>
    io = context.io = socketio context.server, options.io ? {}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Reference to the zappa client, the value will be set later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  client = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Tracks if the zappa middleware is already mounted (<code>@use &#39;zappa&#39;</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  zappa_used = <span class="hljs-literal">no</span>

  views = context.views = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>This is our own version of Express’ original <code>lib/view.js</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZappaView</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(name,options = {})</span> -&gt;</span>
      <span class="hljs-property">@root</span> = options.root ? <span class="hljs-string">''</span>
      engines = options.engines
      defaultEngine = options.defaultEngine
      <span class="hljs-property">@ext</span> = path.extname name
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@ext</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> defaultEngine
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'No default engine was specified and no extensions was provided.'</span>
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@ext</span>
        <span class="hljs-property">@ext</span> = <span class="hljs-keyword">if</span> defaultEngine[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'.'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">".<span class="hljs-subst">#{defaultEngine}</span>"</span> <span class="hljs-keyword">else</span> defaultEngine
        name += <span class="hljs-property">@ext</span>
      [<span class="hljs-property">@path</span>,<span class="hljs-property">@proto</span>] = <span class="hljs-property">@lookup</span> name
      <span class="hljs-keyword">if</span> <span class="hljs-property">@proto</span>?
        <span class="hljs-keyword">if</span> <span class="hljs-property">@proto</span>
          <span class="hljs-property">@engine</span> = engines[<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@ext</span>}</span> zappa"</span>] ?= <span class="hljs-built_in">require</span>(<span class="hljs-property">@ext</span>.slice <span class="hljs-number">1</span>).render
        <span class="hljs-keyword">else</span>
          <span class="hljs-property">@engine</span> = engines[<span class="hljs-property">@ext</span>] ?= <span class="hljs-built_in">require</span>(<span class="hljs-property">@ext</span>.slice <span class="hljs-number">1</span>).__express
      <span class="hljs-property">@path</span>

    <span class="hljs-attribute">lookup</span>: <span class="hljs-function"><span class="hljs-params">(p)</span> -&gt;</span>
<span class="hljs-function">      <span class="hljs-title">exists</span> = <span class="hljs-params">(p)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> views[p]?
          <span class="hljs-keyword">return</span> [p,<span class="hljs-literal">true</span>]
        <span class="hljs-keyword">if</span> fs.existsSync p
          <span class="hljs-keyword">return</span> [p,<span class="hljs-literal">false</span>]
        <span class="hljs-literal">null</span>

      exists( path.resolve <span class="hljs-property">@root</span>, p ) ? exists( path.join path.dirname(p), path.basename(p,<span class="hljs-property">@ext</span>), <span class="hljs-string">"index.<span class="hljs-subst">#{<span class="hljs-property">@ext</span>}</span>"</span> ) ? [<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>]

    <span class="hljs-attribute">render</span>: <span class="hljs-function"><span class="hljs-params">(options,fn)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> <span class="hljs-property">@proto</span>
        e = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">try</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>FIXME: pass parameters as per Express2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          r = <span class="hljs-property">@engine</span> views[<span class="hljs-property">@path</span>], options, <span class="hljs-property">@path</span>
        <span class="hljs-keyword">catch</span> error
          e = <span class="hljs-string">"Engine .render for <span class="hljs-subst">#{<span class="hljs-property">@ext</span>}</span> failed: <span class="hljs-subst">#{error}</span>"</span>
        fn e, r
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@engine</span> <span class="hljs-property">@path</span>, options, fn</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Zappa’s default settings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.set <span class="hljs-string">'view'</span>, ZappaView
  app.set <span class="hljs-string">'view engine'</span>, <span class="hljs-string">'coffee'</span>

  teacup = <span class="hljs-built_in">require</span> <span class="hljs-string">'teacup'</span>
  teacup_express = <span class="hljs-built_in">require</span> <span class="hljs-string">'teacup/lib/express'</span>

  app.engine <span class="hljs-string">'coffee'</span>, teacup_express.renderFile
  app.engine <span class="hljs-string">'coffee zappa'</span>, <span class="hljs-function"><span class="hljs-params">(template,options)</span> -&gt;</span> (teacup.renderable template).call options, options
  context.teacup = teacup

  app.set <span class="hljs-string">'views'</span>, path.join(root, <span class="hljs-string">'/views'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Location of zappa-specific URIs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.set <span class="hljs-string">'zappa_prefix'</span>, <span class="hljs-string">'/zappa'</span>
  app.set <span class="hljs-string">'zappa_channel'</span>, <span class="hljs-string">'__local'</span>

  <span class="hljs-keyword">for</span> verb <span class="hljs-keyword">in</span> [methods...,<span class="hljs-string">'all'</span>]
    <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(verb)</span> -&gt;</span>
      context[verb] = <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
        arity = args.length
        <span class="hljs-keyword">if</span> arity &gt; <span class="hljs-number">1</span>
          route
            <span class="hljs-attribute">verb</span>: verb
            <span class="hljs-attribute">path</span>: args[<span class="hljs-number">0</span>]
            <span class="hljs-attribute">middleware</span>: flatten args[<span class="hljs-number">1.</span>..arity-<span class="hljs-number">1</span>]
            <span class="hljs-attribute">handler</span>: args[arity-<span class="hljs-number">1</span>]
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> arguments[<span class="hljs-number">0</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Apply middleware if value is array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> v <span class="hljs-keyword">instanceof</span> Array
              route
                <span class="hljs-attribute">verb</span>: verb
                <span class="hljs-attribute">path</span>: k
                <span class="hljs-attribute">middleware</span>: flatten v[<span class="hljs-number">0.</span>..v.length-<span class="hljs-number">1</span>]
                <span class="hljs-attribute">handler</span>: v[v.length-<span class="hljs-number">1</span>]

            <span class="hljs-keyword">else</span>
              route <span class="hljs-attribute">verb</span>: verb, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: v
        <span class="hljs-keyword">return</span>

  context.c<span class="hljs-function"><span class="hljs-title">lient</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    context.use <span class="hljs-string">'zappa'</span> <span class="hljs-keyword">unless</span> zappa_used
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      js = <span class="hljs-string">";zappa.run(<span class="hljs-subst">#{v}</span>);"</span>
      js = minify(js) <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'minify'</span>]
      route <span class="hljs-attribute">verb</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: js, <span class="hljs-attribute">type</span>: <span class="hljs-string">'js'</span>
    <span class="hljs-keyword">return</span>

  context.c<span class="hljs-function"><span class="hljs-title">offee</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      js = <span class="hljs-string">";<span class="hljs-subst">#{coffeescript_helpers}</span>(<span class="hljs-subst">#{v}</span>)();"</span>
      js = minify(js) <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'minify'</span>]
      route <span class="hljs-attribute">verb</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: js, <span class="hljs-attribute">type</span>: <span class="hljs-string">'js'</span>
    <span class="hljs-keyword">return</span>

  context.j<span class="hljs-function"><span class="hljs-title">s</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      js = String(v)
      js = minify(js) <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'minify'</span>]
      route <span class="hljs-attribute">verb</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: js, <span class="hljs-attribute">type</span>: <span class="hljs-string">'js'</span>
    <span class="hljs-keyword">return</span>

  context.c<span class="hljs-function"><span class="hljs-title">ss</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> v <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
        coffee_css ?= <span class="hljs-built_in">require</span> <span class="hljs-string">'coffee-css'</span>
        css = coffee_css.compile v
      <span class="hljs-keyword">else</span>
        css = String(v)
      route <span class="hljs-attribute">verb</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: css, <span class="hljs-attribute">type</span>: <span class="hljs-string">'css'</span>
    <span class="hljs-keyword">return</span>

  context.w<span class="hljs-function"><span class="hljs-title">ith</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    zappa_with =
      <span class="hljs-attribute">css</span>: <span class="hljs-function"><span class="hljs-params">(modules)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> modules <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
          modules = [modules]
        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> modules
          <span class="hljs-built_in">module</span> = <span class="hljs-built_in">require</span>(name)
          context[name] = <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
            <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
              <span class="hljs-built_in">module</span>.render v, <span class="hljs-attribute">filename</span>: k, <span class="hljs-function"><span class="hljs-params">(err, css)</span> -&gt;</span>
                <span class="hljs-keyword">throw</span> err <span class="hljs-keyword">if</span> err
                route <span class="hljs-attribute">verb</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: css, <span class="hljs-attribute">type</span>: <span class="hljs-string">'css'</span>
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> obj
      <span class="hljs-keyword">if</span> zappa_with[k]
        zappa_with[k] v

  context.h<span class="hljs-function"><span class="hljs-title">elper</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      helpers[k] = v
    <span class="hljs-keyword">return</span>

  context.o<span class="hljs-function"><span class="hljs-title">n</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      ws_handlers[k] = v
    <span class="hljs-keyword">return</span>

  context.v<span class="hljs-function"><span class="hljs-title">iew</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      ext = path.extname k
      p = path.join app.get(<span class="hljs-string">'views'</span>), k
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ext
        p += <span class="hljs-string">'.'</span> + app.get(<span class="hljs-string">'view engine'</span>)
      views[p] = v
    <span class="hljs-keyword">return</span>

  context.e<span class="hljs-function"><span class="hljs-title">ngine</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      app.engine k, v
    <span class="hljs-keyword">return</span>

  context.s<span class="hljs-function"><span class="hljs-title">et</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      app.set k, v
    <span class="hljs-keyword">return</span>

  context.e<span class="hljs-function"><span class="hljs-title">nable</span> = -&gt;</span>
    app.enable i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> arguments
    <span class="hljs-keyword">return</span>

  context.d<span class="hljs-function"><span class="hljs-title">isable</span> = -&gt;</span>
    app.disable i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> arguments
    <span class="hljs-keyword">return</span>

  context.w<span class="hljs-function"><span class="hljs-title">rap</span> = <span class="hljs-params">(f)</span> -&gt;</span>
<span class="hljs-function">    <span class="hljs-params">(req,res,next)</span> -&gt;</span>
      ctx =
        <span class="hljs-attribute">app</span>: app
        <span class="hljs-attribute">settings</span>: app.settings
        <span class="hljs-attribute">locals</span>: res.locals
        <span class="hljs-attribute">request</span>: req
        <span class="hljs-attribute">req</span>: req
        <span class="hljs-attribute">query</span>: req.query
        <span class="hljs-attribute">params</span>: req.params
        <span class="hljs-attribute">body</span>: req.body
        <span class="hljs-attribute">session</span>: req.session
        <span class="hljs-attribute">response</span>: res
        <span class="hljs-attribute">res</span>: res
        <span class="hljs-attribute">next</span>: next
        <span class="hljs-attribute">send</span>:<span class="hljs-function"> -&gt;</span> res.send.apply res, arguments
        <span class="hljs-attribute">json</span>:<span class="hljs-function"> -&gt;</span> res.json.apply res, arguments
        <span class="hljs-attribute">jsonp</span>:<span class="hljs-function"> -&gt;</span> res.jsonp.apply res, arguments
        <span class="hljs-attribute">redirect</span>:<span class="hljs-function"> -&gt;</span> res.redirect.apply res, arguments
        <span class="hljs-attribute">format</span>:<span class="hljs-function"> -&gt;</span> res.format.apply res, arguments
      apply_helpers ctx
      f.call ctx, req, res, next

  context.u<span class="hljs-function"><span class="hljs-title">se</span> = -&gt;</span>
    zappa_middleware =
      <span class="hljs-attribute">static</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> options <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
          options = <span class="hljs-attribute">path</span>: options
        options ?= {}
        p = options.path ? path.join(root, <span class="hljs-string">'/public'</span>)
        <span class="hljs-keyword">delete</span> options.path
        serveStatic(p,options)
      <span class="hljs-attribute">zappa</span>:<span class="hljs-function"> -&gt;</span>
        zappa_used = <span class="hljs-literal">yes</span>
<span class="hljs-function">        <span class="hljs-params">(req, res, next)</span> -&gt;</span>
<span class="hljs-function">          <span class="hljs-title">send</span> = <span class="hljs-params">(code)</span> -&gt;</span>
            res.type <span class="hljs-string">'js'</span>
            res.send code
          <span class="hljs-keyword">if</span> req.method.toUpperCase() <span class="hljs-keyword">isnt</span> <span class="hljs-string">'GET'</span> <span class="hljs-keyword">then</span> next()
          <span class="hljs-keyword">else</span>
            zappa_prefix = app.settings.zappa_prefix
            <span class="hljs-keyword">switch</span> req.url
              <span class="hljs-keyword">when</span> zappa_prefix+<span class="hljs-string">'/full.js'</span> <span class="hljs-keyword">then</span> send client_bundled()
              <span class="hljs-keyword">when</span> zappa_prefix+<span class="hljs-string">'/simple.js'</span> <span class="hljs-keyword">then</span> send client_bundle_simple()
              <span class="hljs-keyword">when</span> zappa_prefix+<span class="hljs-string">'/zappa.js'</span> <span class="hljs-keyword">then</span> send client
              <span class="hljs-keyword">when</span> zappa_prefix+<span class="hljs-string">'/jquery.js'</span> <span class="hljs-keyword">then</span> send jquery_minified()
              <span class="hljs-keyword">when</span> zappa_prefix+<span class="hljs-string">'/sammy.js'</span> <span class="hljs-keyword">then</span> send sammy_minified()
              <span class="hljs-keyword">when</span> zappa_prefix+<span class="hljs-string">'/socket.io.js'</span> <span class="hljs-keyword">then</span> send socketjs()
              <span class="hljs-keyword">else</span> next()
          <span class="hljs-keyword">return</span>
      <span class="hljs-attribute">session</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
        context.session_store = options.store
        session options
<span class="hljs-function">
    <span class="hljs-title">use</span> = <span class="hljs-params">(name, arg = <span class="hljs-literal">null</span>)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> zappa_middleware[name]
        app.use zappa_middleware[name](arg)
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> express[name] <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
        app.use express[name](arg)
      <span class="hljs-keyword">else</span>
        app.use (<span class="hljs-built_in">require</span> name)(arg)

    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> arguments
      <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> a
        <span class="hljs-keyword">when</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> app.use a
        <span class="hljs-keyword">when</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> use a
        <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
          <span class="hljs-keyword">if</span> a.stack? <span class="hljs-keyword">or</span> a.route? <span class="hljs-keyword">or</span> a.handle?
            app.use a
          <span class="hljs-keyword">else</span>
            use k, v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> a
    <span class="hljs-keyword">return</span>

  context.settings = app.settings
  context.locals = app.locals

  context.s<span class="hljs-function"><span class="hljs-title">hared</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    context.use <span class="hljs-string">'zappa'</span> <span class="hljs-keyword">unless</span> zappa_used
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      js = <span class="hljs-string">";zappa.run(<span class="hljs-subst">#{v}</span>);"</span>
      js = minify(js) <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'minify'</span>]
      route <span class="hljs-attribute">verb</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: js, <span class="hljs-attribute">type</span>: <span class="hljs-string">'js'</span>
      v.apply context
    <span class="hljs-keyword">return</span>

  context.i<span class="hljs-function"><span class="hljs-title">nclude</span> = <span class="hljs-params">(p)</span> -&gt;</span>
    sub = <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> p <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">require</span> path.join(root, p) <span class="hljs-keyword">else</span> p
    sub.include.apply context
<span class="hljs-function">
  <span class="hljs-title">apply_helpers</span> = <span class="hljs-params">(ctx)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> name, helper <span class="hljs-keyword">of</span> helpers
      <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(name, helper)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> helper <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
          ctx[name] =<span class="hljs-function"> -&gt;</span>
            helper.apply ctx, arguments
        <span class="hljs-keyword">else</span>
          ctx[name] = helper
        <span class="hljs-keyword">return</span>
    ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Local socket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">request_socket</span> = <span class="hljs-params">(req)</span> -&gt;</span>
    socket_id = req.session?.__socket?[app.settings.zappa_channel]?.id
    <span class="hljs-keyword">if</span> socket_id</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>io.sockets is the default namespace (=== io.of(‘/‘)).
io.sockets.sockets is the list of sockets in that namespace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> socket <span class="hljs-keyword">in</span> io.sockets.sockets
        <span class="hljs-keyword">return</span> socket <span class="hljs-keyword">if</span> socket.id <span class="hljs-keyword">is</span> socket_id
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>The callback will receive (err,session).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">socket_session</span> = <span class="hljs-params">(socket,cb)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>First retrieve the data record associated with the socket.id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    context.session_store.get socket.id, <span class="hljs-function"><span class="hljs-params">(err,data)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> err
        <span class="hljs-keyword">return</span> cb err.toString(), <span class="hljs-literal">null</span>
      <span class="hljs-keyword">if</span> data?.id?</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Then retrieve the session data stored by Express</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        context.session_store.get data.id, cb
      <span class="hljs-keyword">else</span>
        cb <span class="hljs-string">'Invalid data record'</span>, <span class="hljs-literal">null</span>

  context.p<span class="hljs-function"><span class="hljs-title">aram</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
<span class="hljs-function">    <span class="hljs-title">build</span> = <span class="hljs-params">(callback)</span> -&gt;</span>
<span class="hljs-function">      <span class="hljs-params">(req,res,next,p)</span> -&gt;</span>
        ctx =
          <span class="hljs-attribute">app</span>: app
          <span class="hljs-attribute">settings</span>: app.settings
          <span class="hljs-attribute">locals</span>: res.locals
          <span class="hljs-attribute">request</span>: req
          <span class="hljs-attribute">req</span>: req
          <span class="hljs-attribute">query</span>: req.query
          <span class="hljs-attribute">params</span>: req.params
          <span class="hljs-attribute">body</span>: req.body
          <span class="hljs-attribute">session</span>: req.session
          <span class="hljs-attribute">response</span>: res
          <span class="hljs-attribute">res</span>: res
          <span class="hljs-attribute">next</span>: next
          <span class="hljs-attribute">param</span>: p
        apply_helpers ctx
        callback.call ctx, req, res, next, p

    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      <span class="hljs-property">@app</span>.param k, build v

    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Register a route with express.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">route</span> = <span class="hljs-params">(r)</span> -&gt;</span>
    r.middleware ?= []

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> r.handler <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
      app[r.verb] r.path, r.middleware, <span class="hljs-function"><span class="hljs-params">(req, res)</span> -&gt;</span>
        res.type r.type <span class="hljs-keyword">if</span> r.type?
        res.send r.handler
        <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">else</span>
      app[r.verb] r.path, r.middleware, <span class="hljs-function"><span class="hljs-params">(req, res, next)</span> -&gt;</span>
        ctx =
          <span class="hljs-attribute">app</span>: app
          <span class="hljs-attribute">settings</span>: app.settings
          <span class="hljs-attribute">locals</span>: res.locals
          <span class="hljs-attribute">request</span>: req
          <span class="hljs-attribute">req</span>: req
          <span class="hljs-attribute">query</span>: req.query
          <span class="hljs-attribute">params</span>: req.params
          <span class="hljs-attribute">body</span>: req.body
          <span class="hljs-attribute">session</span>: req.session
          <span class="hljs-attribute">response</span>: res
          <span class="hljs-attribute">res</span>: res
          <span class="hljs-attribute">next</span>: next
          <span class="hljs-attribute">send</span>:<span class="hljs-function"> -&gt;</span> res.send.apply res, arguments
          <span class="hljs-attribute">json</span>:<span class="hljs-function"> -&gt;</span> res.json.apply res, arguments
          <span class="hljs-attribute">jsonp</span>:<span class="hljs-function"> -&gt;</span> res.jsonp.apply res, arguments
          <span class="hljs-attribute">redirect</span>:<span class="hljs-function"> -&gt;</span> res.redirect.apply res, arguments
          <span class="hljs-attribute">format</span>:<span class="hljs-function"> -&gt;</span> res.format.apply res, arguments
          <span class="hljs-attribute">render</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> arguments[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span>
              render.apply @, arguments
            <span class="hljs-keyword">else</span>
              <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> arguments[<span class="hljs-number">0</span>]
                render.apply @, [k, v]
            <span class="hljs-keyword">return</span>
          <span class="hljs-attribute">emit</span>:<span class="hljs-function"> -&gt;</span>
            socket = request_socket req
            <span class="hljs-keyword">if</span> socket?
              <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> arguments[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span>
                socket.emit.apply socket, arguments
              <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> arguments[<span class="hljs-number">0</span>]
                  socket.emit.apply socket, [k, v]
            <span class="hljs-keyword">return</span>
<span class="hljs-function">
        <span class="hljs-title">render</span> = <span class="hljs-params">(name,opts = {},fn)</span> -&gt;</span>

          report = fn ? <span class="hljs-function"><span class="hljs-params">(err,html)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> err
              next err
            <span class="hljs-keyword">else</span>
              res.send html</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Make sure the second arg is an object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> opts <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
            fn = opts
            opts = {}

          res.render.call res, name, opts, report

        apply_helpers ctx

        <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'x-powered-by'</span>]
          res.setHeader <span class="hljs-string">'X-Powered-By'</span>, <span class="hljs-string">"Zappa <span class="hljs-subst">#{zappa.version}</span>"</span>

        result = r.handler.call ctx, req, res, next

        res.type(r.type) <span class="hljs-keyword">if</span> r.type?
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> result <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> res.send result
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> result</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Register socket.io handlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  io?.sockets.<span class="hljs-literal">on</span> <span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-params">(socket)</span> -&gt;</span>
    c = {}
<span class="hljs-function">
    <span class="hljs-title">build_ctx</span> = -&gt;</span>
      ctx =
        <span class="hljs-attribute">app</span>: app
        <span class="hljs-attribute">io</span>: io
        <span class="hljs-attribute">settings</span>: app.settings
        <span class="hljs-attribute">locals</span>: app.locals
        <span class="hljs-attribute">socket</span>: socket
        <span class="hljs-attribute">id</span>: socket.id
        <span class="hljs-attribute">client</span>: c
        <span class="hljs-attribute">join</span>: <span class="hljs-function"><span class="hljs-params">(room)</span> -&gt;</span>
          socket.join room
        <span class="hljs-attribute">leave</span>: <span class="hljs-function"><span class="hljs-params">(room)</span> -&gt;</span>
          socket.leave room
        <span class="hljs-attribute">emit</span>:<span class="hljs-function"> -&gt;</span>
          <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> arguments[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span>
            socket.emit.apply socket, arguments
          <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> arguments[<span class="hljs-number">0</span>]
              socket.emit.apply socket, [k, v]
          <span class="hljs-keyword">return</span>
        <span class="hljs-attribute">broadcast</span>:<span class="hljs-function"> -&gt;</span>
          broadcast = socket.broadcast
          <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> arguments[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span>
            broadcast.emit.apply broadcast, arguments
          <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> arguments[<span class="hljs-number">0</span>]
              broadcast.emit.apply broadcast, [k, v]
          <span class="hljs-keyword">return</span>
        <span class="hljs-attribute">broadcast_to</span>: <span class="hljs-function"><span class="hljs-params">(room, args...)</span> -&gt;</span>
          room = io.sockets.<span class="hljs-keyword">in</span> room
          <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span>
            room.emit.apply room, args
          <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> args[<span class="hljs-number">0</span>]
              room.emit.apply room, [k, v]
          <span class="hljs-keyword">return</span>
        <span class="hljs-attribute">session</span>:<span class="hljs-function"> -&gt;</span> socket_session socket, arguments...

      apply_helpers ctx
      ctx

    ctx = build_ctx()
    ws_handlers.connection.apply(ctx) <span class="hljs-keyword">if</span> ws_handlers.connection?

    socket.<span class="hljs-literal">on</span> <span class="hljs-string">'disconnect'</span>,<span class="hljs-function"> -&gt;</span>
      ctx = build_ctx()
      ws_handlers.disconnect.apply(ctx) <span class="hljs-keyword">if</span> ws_handlers.disconnect?

    <span class="hljs-keyword">for</span> name, h <span class="hljs-keyword">of</span> ws_handlers
      <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(name, h)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> name <span class="hljs-keyword">isnt</span> <span class="hljs-string">'connection'</span> <span class="hljs-keyword">and</span> name <span class="hljs-keyword">isnt</span> <span class="hljs-string">'disconnect'</span>
          socket.<span class="hljs-literal">on</span> name, <span class="hljs-function"><span class="hljs-params">(data, ack)</span> -&gt;</span>
            ctx = build_ctx()
            ctx.data = data
            ctx.ack = ack
            h.call ctx, data, ack
        <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Go!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  func.apply context
<span class="hljs-function">
  <span class="hljs-title">jquery</span> = -&gt;</span> jquery.content ?= app.settings.jquery_js ? vendor_module <span class="hljs-string">'jquery'</span>, <span class="hljs-string">'jquery.js'</span>
<span class="hljs-function">  <span class="hljs-title">jquery_minified</span> = -&gt;</span> jquery_minified.content ?= app.settings.jquery_min_js ? vendor_module <span class="hljs-string">'jquery'</span>, <span class="hljs-string">'jquery.min.js'</span>
<span class="hljs-function">  <span class="hljs-title">sammy</span> = -&gt;</span> sammy.content ?= app.settings.sammy_js ? vendor_module <span class="hljs-string">'sammy'</span>, <span class="hljs-string">'sammy.js'</span>
<span class="hljs-function">  <span class="hljs-title">sammy_minified</span> = -&gt;</span> sammy_minified.content ?= app.settings.sammy_min_js ? vendor_module <span class="hljs-string">'sammy'</span>, <span class="hljs-string">'min'</span>, <span class="hljs-string">'sammy-latest.min.js'</span>
<span class="hljs-function">  <span class="hljs-title">socketjs</span> = -&gt;</span> socketjs.content ?= app.settings.socketio_js ? vendor_module <span class="hljs-string">'socket.io-client'</span>, <span class="hljs-string">'socket.io.js'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>The stringified zappa client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  client = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./client'</span>).build(zappa.version, app.settings)
  client = <span class="hljs-string">";<span class="hljs-subst">#{coffeescript_helpers}</span>(<span class="hljs-subst">#{client}</span>)();"</span>
<span class="hljs-function">  <span class="hljs-title">client_bundle_simple</span> = -&gt;</span> client_bundle_simple.content ?=
    <span class="hljs-keyword">if</span> io?
      jquery() + socketjs() + client
    <span class="hljs-keyword">else</span>
      jquery() + client
<span class="hljs-function">  <span class="hljs-title">client_bundled</span> = -&gt;</span> client_bundled.content ?=
    <span class="hljs-keyword">if</span> io?
      jquery() + socketjs() + sammy() + client
    <span class="hljs-keyword">else</span>
      jquery() + sammy() + client

  <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'minify'</span>]
    client = minify client
    client_bundle_simple.content = minify client_bundle_simple()
    client_bundled.content = minify client_bundled()
    socketjs.content = minify socketjs()

  <span class="hljs-keyword">do</span> <span class="hljs-function">-&gt;</span>
    zappa_prefix = app.settings.zappa_prefix
    context.get zappa_prefix+<span class="hljs-string">'/socket/:channel_name/:socket_id'</span>,<span class="hljs-function"> -&gt;</span>
      <span class="hljs-keyword">if</span> <span class="hljs-property">@session</span>?
        channel_name = <span class="hljs-property">@params</span>.channel_name
        socket_id = <span class="hljs-property">@params</span>.socket_id

        <span class="hljs-property">@session</span>.__socket ?= {}

        <span class="hljs-keyword">if</span> <span class="hljs-property">@session</span>.__socket[channel_name]?</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Client (or hijacker) trying to re-key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@json</span> <span class="hljs-attribute">error</span>:<span class="hljs-string">'Channel already assigned'</span>, <span class="hljs-attribute">channel_name</span>: channel_name
        <span class="hljs-keyword">else</span>
          key = uuid.v4() <span class="hljs-comment"># used for socket 'authorization'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Update the Express session store</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@session</span>.__socket[channel_name] =
            <span class="hljs-attribute">id</span>: socket_id
            <span class="hljs-attribute">key</span>: key</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Update the store.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          data =
            <span class="hljs-attribute">id</span>: <span class="hljs-property">@req</span>.sessionID   <span class="hljs-comment"># local Express Session ID</span>
            <span class="hljs-attribute">key</span>: key
            <span class="hljs-attribute">cookie</span>: {}
          context.session_store.set socket_id, data, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
            <span class="hljs-keyword">if</span> err
              <span class="hljs-property">@json</span> <span class="hljs-attribute">error</span>: err.toString()
              <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Let the client know which key to use.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@json</span> <span class="hljs-attribute">channel_name</span>: channel_name, <span class="hljs-attribute">key</span>: key
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@json</span> <span class="hljs-attribute">error</span>:<span class="hljs-string">'No session'</span>
      <span class="hljs-keyword">return</span>

  context</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>zappa.run [host,] [port,] [{options},] root_function
Takes a function and runs it as a zappa app. Optionally accepts a port
number, and/or a hostname (any order). The hostname must be a string, and
the port number must be castable as a number.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
zappa.r<span class="hljs-function"><span class="hljs-title">un</span> = -&gt;</span>
  host = <span class="hljs-literal">null</span>
  port = <span class="hljs-number">3000</span>
  root_function = <span class="hljs-literal">null</span>
  options = {}

  <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> arguments
    <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'string'</span>
        <span class="hljs-keyword">if</span> isNaN( (Number) a ) <span class="hljs-keyword">then</span> host = a
        <span class="hljs-keyword">else</span> port = (Number) a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">then</span> port = a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> root_function = a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> a
          <span class="hljs-keyword">switch</span> k
            <span class="hljs-keyword">when</span> <span class="hljs-string">'host'</span> <span class="hljs-keyword">then</span> host = v
            <span class="hljs-keyword">when</span> <span class="hljs-string">'port'</span> <span class="hljs-keyword">then</span> port = v
            <span class="hljs-keyword">else</span> options[k] = v

  zapp = zappa.app(root_function,options)
  {server,app} = zapp
<span class="hljs-function">
  <span class="hljs-title">express_ready</span> = -&gt;</span>
    addr = server.address()
    log <span class="hljs-string">"""
      Express server listening on <span class="hljs-subst">#{addr.address}</span>:<span class="hljs-subst">#{addr.port}</span> in <span class="hljs-subst">#{app.settings.env}</span> mode.
      Zappa <span class="hljs-subst">#{zappa.version}</span> orchestrating the show.

    """</span>

  <span class="hljs-keyword">if</span> host
    server.listen port, host, express_ready
  <span class="hljs-keyword">else</span>
    server.listen port, express_ready

  zapp

<span class="hljs-built_in">module</span>.exports = zappa.run
<span class="hljs-built_in">module</span>.exports.run = zappa.run
<span class="hljs-built_in">module</span>.exports.app = zappa.app
<span class="hljs-built_in">module</span>.exports.version = zappa.version</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
