<!DOCTYPE html>

<html>
<head>
  <title>zappa.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="client.html">
                client.coffee
              </a>
            
              
              <a class="source" href="zappa.html">
                zappa.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>zappa.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><strong>Zappa</strong> is a <a href="http://coffeescript.org">CoffeeScript</a> DSL-ish interface
for building web apps on the <a href="http://nodejs.org">node.js</a> runtime,
integrating <a href="http://expressjs.com">express</a>, <a href="http://socket.io">socket.io</a>
and other best-of-breed libraries.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
zappa = <span class="hljs-attribute">version</span>: <span class="hljs-string">'0.5.0'</span>

codename = <span class="hljs-string">'You can\'t do that on stage anymore'</span>

log = <span class="hljs-built_in">console</span>.log
fs = <span class="hljs-built_in">require</span> <span class="hljs-string">'fs'</span>
path = <span class="hljs-built_in">require</span> <span class="hljs-string">'path'</span>
uuid = <span class="hljs-built_in">require</span> <span class="hljs-string">'node-uuid'</span>
uglify = <span class="hljs-built_in">require</span> <span class="hljs-string">'uglify-js'</span>
methods = <span class="hljs-built_in">require</span> <span class="hljs-string">'methods'</span>
<span class="hljs-function">
<span class="hljs-title">vendor</span> = <span class="hljs-params">(name)</span> -&gt;</span>
  fs.readFileSync(path.join(__dirname,<span class="hljs-string">'..'</span>,<span class="hljs-string">'vendor'</span>,name)).toString()

jquery = vendor <span class="hljs-string">'jquery.js'</span>
jquery_minified = vendor <span class="hljs-string">'jquery.min.js'</span>
sammy = vendor <span class="hljs-string">'sammy.js'</span>
sammy_minified = vendor <span class="hljs-string">'sammy.min.js'</span>
socketjs = vendor <span class="hljs-string">'socket.io.js'</span>

socketio_key = <span class="hljs-string">'__session'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Soft dependencies:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>jsdom = <span class="hljs-literal">null</span>
express_partials = <span class="hljs-literal">null</span>
coffee_css = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>CoffeeScript-generated JavaScript may contain anyone of these; when we
“rewrite” a function (see below) though, it loses access to its parent scope,
and consequently to any helpers it might need. So we need to reintroduce
these helpers manually inside any “rewritten” function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>coffeescript_helpers = <span class="hljs-string">"""
  var __slice = Array.prototype.slice;
  var __hasProp = Object.prototype.hasOwnProperty;
  var __bind = function(fn, me){
    return function(){ return fn.apply(me, arguments); };
  };
  var __extends = function(child, parent) {
    for (var key in parent) {
      if (__hasProp.call(parent, key)) child[key] = parent[key];
    }
    function ctor() { this.constructor = child; }
    ctor.prototype = parent.prototype;
    child.prototype = new ctor;
    child.__super__ = parent.prototype;
    return child;
  };
  var __indexOf = Array.prototype.indexOf || function(item) {
    for (var i = 0, l = this.length; i &lt; l; i++) {
      if (this[i] === item) return i;
    } return -1; };
"""</span>.replace <span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">''</span>
<span class="hljs-function">
<span class="hljs-title">minify</span> = <span class="hljs-params">(js)</span> -&gt;</span>
  result = uglify.minify js, <span class="hljs-attribute">fromString</span>:<span class="hljs-literal">true</span>
  result.code</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Shallow copy attributes from <code>sources</code> (array of objects) to <code>recipient</code>.
Does NOT overwrite attributes already present in <code>recipient</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">copy_data_to</span> = <span class="hljs-params">(recipient, sources)</span> -&gt;</span>
  <span class="hljs-keyword">for</span> obj <span class="hljs-keyword">in</span> sources
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      recipient[k] = v <span class="hljs-keyword">unless</span> recipient[k]
  <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Flatten array recursively (copied from Express’s utils.js)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">flatten</span> = <span class="hljs-params">(arr, ret)</span> -&gt;</span>
  ret ?= []
  <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> arr
    <span class="hljs-keyword">if</span> Array.isArray o
      flatten o, ret
    <span class="hljs-keyword">else</span>
      ret.push o
  ret</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Zappa FS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>zappa_fs = {}
<span class="hljs-function">
<span class="hljs-title">native_name</span> = <span class="hljs-params">(p)</span> -&gt;</span>
  p.replace <span class="hljs-regexp">/\/\.zappa-[^\/]+/</span>, <span class="hljs-string">''</span>
<span class="hljs-function">
<span class="hljs-title">install_zappa_fs</span> = -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> install_zappa_fs.done
  install_zappa_fs.done = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Patch Node.js’s <code>fs</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  native_readFileSync = fs.readFileSync
  native_readFile = fs.readFile
<span class="hljs-function">
  <span class="hljs-title">native_array</span> = <span class="hljs-params">(args...)</span> -&gt;</span>
    args[<span class="hljs-number">0</span>] = native_name args[<span class="hljs-number">0</span>]
    args

  fs.r<span class="hljs-function"><span class="hljs-title">eadFileSync</span> = <span class="hljs-params">(p,encoding)</span> -&gt;</span>
    zappa_fs[p] ? native_readFileSync.apply fs, native_array arguments...

  fs.r<span class="hljs-function"><span class="hljs-title">eadFile</span> = <span class="hljs-params">(p,encoding,callback)</span> -&gt;</span>
    view = zappa_fs[p]
    <span class="hljs-keyword">if</span> view
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> encoding <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> callback?
        callback = encoding
      callback <span class="hljs-literal">null</span>, view
    <span class="hljs-keyword">else</span>
      native_readFile.apply fs, native_array arguments...

  native_existsSync = fs.existsSync ? path.existsSync
  native_exists = fs.exists ? path.exists

  path.existsSync = fs.e<span class="hljs-function"><span class="hljs-title">xistsSync</span> = <span class="hljs-params">(p)</span> -&gt;</span>
    zappa_fs[p]? <span class="hljs-keyword">or</span> native_existsSync.apply fs, native_array arguments...

  path.exists = fs.e<span class="hljs-function"><span class="hljs-title">xists</span> = <span class="hljs-params">(p,callback)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> zappa_fs[p]?
      callback <span class="hljs-literal">true</span>
    <span class="hljs-keyword">else</span>
      native_exists.apply fs, native_array arguments...</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Takes in a function and builds express/socket.io apps based on the rules
contained in it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>zappa.a<span class="hljs-function"><span class="hljs-title">pp</span> = -&gt;</span>
  <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> arguments
    <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'function'</span>
        func = a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
        options = a

  options ?= {}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>All ZappaJS instances MUST share the same Express module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  install_zappa_fs()</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Express must first be called after we modify the <code>fs</code> module.
If using a different version of Express, make sure to call zappa.install_fs() first.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  express = options.express ? <span class="hljs-built_in">require</span> <span class="hljs-string">'express'</span>

  context = {<span class="hljs-attribute">id</span>: uuid.v4(), zappa, express}

  real_root = path.dirname(<span class="hljs-built_in">module</span>.parent.filename)
  root =  path.join real_root, <span class="hljs-string">".zappa-<span class="hljs-subst">#{context.id}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Storage for user-provided stuff.
Views are kept at the module level.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ws_handlers = {}
  helpers = {}
  postrenders = {}
  partials = {}

  app = context.app = express()
  <span class="hljs-keyword">if</span> options.https?
    context.server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'https'</span>).createServer options.https, app
  <span class="hljs-keyword">else</span>
    context.server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>).createServer app
  <span class="hljs-keyword">if</span> options.disable_io
    io = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">else</span>
    socketio = options.socketio ? <span class="hljs-built_in">require</span> <span class="hljs-string">'socket.io'</span>
    io = context.io = socketio.listen context.server, options.io ? {}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Reference to the zappa client, the value will be set later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  client = <span class="hljs-literal">null</span>
  client_bundled = <span class="hljs-literal">null</span>
  client_bundle_simple = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Tracks if the zappa middleware is already mounted (<code>@use &#39;zappa&#39;</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  zappa_used = <span class="hljs-literal">no</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Zappa’s default settings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.set <span class="hljs-string">'view engine'</span>, <span class="hljs-string">'coffee'</span>
  app.engine <span class="hljs-string">'coffee'</span>, coffeecup_adapter</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Sets default view dir to @root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.set <span class="hljs-string">'views'</span>, path.join(root, <span class="hljs-string">'/views'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Location of zappa-specific URIs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.set <span class="hljs-string">'zappa_prefix'</span>, <span class="hljs-string">'/zappa'</span>

  <span class="hljs-keyword">for</span> verb <span class="hljs-keyword">in</span> [methods...,<span class="hljs-string">'del'</span>,<span class="hljs-string">'all'</span>]
    <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(verb)</span> -&gt;</span>
      context[verb] = <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
        arity = args.length
        <span class="hljs-keyword">if</span> arity &gt; <span class="hljs-number">1</span>
          route
            <span class="hljs-attribute">verb</span>: verb
            <span class="hljs-attribute">path</span>: args[<span class="hljs-number">0</span>]
            <span class="hljs-attribute">middleware</span>: flatten args[<span class="hljs-number">1.</span>..arity-<span class="hljs-number">1</span>]
            <span class="hljs-attribute">handler</span>: args[arity-<span class="hljs-number">1</span>]
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> arguments[<span class="hljs-number">0</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Apply middleware if value is array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> v <span class="hljs-keyword">instanceof</span> Array
              route
                <span class="hljs-attribute">verb</span>: verb
                <span class="hljs-attribute">path</span>: k
                <span class="hljs-attribute">middleware</span>: flatten v[<span class="hljs-number">0.</span>..v.length-<span class="hljs-number">1</span>]
                <span class="hljs-attribute">handler</span>: v[v.length-<span class="hljs-number">1</span>]

            <span class="hljs-keyword">else</span>
              route <span class="hljs-attribute">verb</span>: verb, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: v
        <span class="hljs-keyword">return</span>

  context.c<span class="hljs-function"><span class="hljs-title">lient</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    context.use <span class="hljs-string">'zappa'</span> <span class="hljs-keyword">unless</span> zappa_used
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      js = <span class="hljs-string">";zappa.run(<span class="hljs-subst">#{v}</span>);"</span>
      js = minify(js) <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'minify'</span>]
      route <span class="hljs-attribute">verb</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: js, <span class="hljs-attribute">contentType</span>: <span class="hljs-string">'js'</span>
    <span class="hljs-keyword">return</span>

  context.c<span class="hljs-function"><span class="hljs-title">offee</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      js = <span class="hljs-string">";<span class="hljs-subst">#{coffeescript_helpers}</span>(<span class="hljs-subst">#{v}</span>)();"</span>
      js = minify(js) <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'minify'</span>]
      route <span class="hljs-attribute">verb</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: js, <span class="hljs-attribute">contentType</span>: <span class="hljs-string">'js'</span>
    <span class="hljs-keyword">return</span>

  context.j<span class="hljs-function"><span class="hljs-title">s</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      js = String(v)
      js = minify(js) <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'minify'</span>]
      route <span class="hljs-attribute">verb</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: js, <span class="hljs-attribute">contentType</span>: <span class="hljs-string">'js'</span>
    <span class="hljs-keyword">return</span>

  context.c<span class="hljs-function"><span class="hljs-title">ss</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> v <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
        coffee_css ?= <span class="hljs-built_in">require</span> <span class="hljs-string">'coffee-css'</span>
        css = coffee_css.compile v
      <span class="hljs-keyword">else</span>
        css = String(v)
      route <span class="hljs-attribute">verb</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: css, <span class="hljs-attribute">contentType</span>: <span class="hljs-string">'css'</span>
    <span class="hljs-keyword">return</span>

  context.w<span class="hljs-function"><span class="hljs-title">ith</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    zappa_with =
      <span class="hljs-attribute">css</span>: <span class="hljs-function"><span class="hljs-params">(modules)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> modules <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
          modules = [modules]
        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> modules
          <span class="hljs-built_in">module</span> = <span class="hljs-built_in">require</span>(name)
          context[name] = <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
            <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
              <span class="hljs-built_in">module</span>.render v, <span class="hljs-attribute">filename</span>: k, <span class="hljs-function"><span class="hljs-params">(err, css)</span> -&gt;</span>
                <span class="hljs-keyword">throw</span> err <span class="hljs-keyword">if</span> err
                route <span class="hljs-attribute">verb</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: css, <span class="hljs-attribute">contentType</span>: <span class="hljs-string">'css'</span>
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> obj
      <span class="hljs-keyword">if</span> zappa_with[k]
        zappa_with[k] v

  context.h<span class="hljs-function"><span class="hljs-title">elper</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      helpers[k] = v
    <span class="hljs-keyword">return</span>

  context.p<span class="hljs-function"><span class="hljs-title">ostrender</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    jsdom = <span class="hljs-built_in">require</span> <span class="hljs-string">'jsdom'</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      postrenders[k] = v
    <span class="hljs-keyword">return</span>

  context.o<span class="hljs-function"><span class="hljs-title">n</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      ws_handlers[k] = v
    <span class="hljs-keyword">return</span>

  context.v<span class="hljs-function"><span class="hljs-title">iew</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      ext = path.extname k
      p = path.join app.get(<span class="hljs-string">'views'</span>), k</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>I’m not even sure this is needed — Express doesn’t ask for it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      zappa_fs[p] = v
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ext
        ext = <span class="hljs-string">'.'</span> + app.get <span class="hljs-string">'view engine'</span>
        zappa_fs[p+ext] = v
    <span class="hljs-keyword">return</span>

  context.e<span class="hljs-function"><span class="hljs-title">ngine</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      app.engine k, v
    <span class="hljs-keyword">return</span>

  context.s<span class="hljs-function"><span class="hljs-title">et</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      app.set k, v
    <span class="hljs-keyword">return</span>

  context.e<span class="hljs-function"><span class="hljs-title">nable</span> = -&gt;</span>
    app.enable i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> arguments
    <span class="hljs-keyword">return</span>

  context.d<span class="hljs-function"><span class="hljs-title">isable</span> = -&gt;</span>
    app.disable i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> arguments
    <span class="hljs-keyword">return</span>
<span class="hljs-function">
  <span class="hljs-title">wrap_middleware</span> = <span class="hljs-params">(f)</span> -&gt;</span>
<span class="hljs-function">    <span class="hljs-params">(req,res,next)</span> -&gt;</span>
      ctx =
        <span class="hljs-attribute">app</span>: app
        <span class="hljs-attribute">settings</span>: app.settings
        <span class="hljs-attribute">locals</span>: res.locals
        <span class="hljs-attribute">request</span>: req
        <span class="hljs-attribute">req</span>: req
        <span class="hljs-attribute">query</span>: req.query
        <span class="hljs-attribute">params</span>: req.params
        <span class="hljs-attribute">body</span>: req.body
        <span class="hljs-attribute">session</span>: req.session
        <span class="hljs-attribute">response</span>: res
        <span class="hljs-attribute">res</span>: res
        <span class="hljs-attribute">next</span>: next

      apply_helpers ctx

      <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'databag'</span>]
        ctx.data = {}
        copy_data_to ctx.data, [req.query, req.params, req.body]

      f.call ctx, req, res, next

  context.m<span class="hljs-function"><span class="hljs-title">iddleware</span> = <span class="hljs-params">(f)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>If magic middleware is enabled the function will get wrapped
by the caller; do not double-wrap it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'magic middleware'</span>]
      f
    <span class="hljs-keyword">else</span>
      wrap_middleware f
<span class="hljs-function">
  <span class="hljs-title">use_middleware</span> = <span class="hljs-params">(f)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'magic middleware'</span>]
      wrap_middleware f
    <span class="hljs-keyword">else</span>
      f

  context.u<span class="hljs-function"><span class="hljs-title">se</span> = -&gt;</span>
    zappa_middleware =</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Connect <code>static</code> middlewate uses fs.stat().</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-attribute">static</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> options <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
          options = <span class="hljs-attribute">path</span>: options
        options ?= {}
        p = options.path ? path.join(real_root, <span class="hljs-string">'/public'</span>)
        <span class="hljs-keyword">delete</span> options.path
        express.static(p,options)
      <span class="hljs-attribute">zappa</span>:<span class="hljs-function"> -&gt;</span>
        zappa_used = <span class="hljs-literal">yes</span>
<span class="hljs-function">        <span class="hljs-params">(req, res, next)</span> -&gt;</span>
<span class="hljs-function">          <span class="hljs-title">send</span> = <span class="hljs-params">(code)</span> -&gt;</span>
            res.contentType <span class="hljs-string">'js'</span>
            res.send code
          <span class="hljs-keyword">if</span> req.method.toUpperCase() <span class="hljs-keyword">isnt</span> <span class="hljs-string">'GET'</span> <span class="hljs-keyword">then</span> next()
          <span class="hljs-keyword">else</span>
            zappa_prefix = app.settings[<span class="hljs-string">'zappa_prefix'</span>]
            <span class="hljs-keyword">switch</span> req.url
              <span class="hljs-keyword">when</span> zappa_prefix+<span class="hljs-string">'/Zappa.js'</span> <span class="hljs-keyword">then</span> send client_bundled
              <span class="hljs-keyword">when</span> zappa_prefix+<span class="hljs-string">'/Zappa-simple.js'</span> <span class="hljs-keyword">then</span> send client_bundle_simple
              <span class="hljs-keyword">when</span> zappa_prefix+<span class="hljs-string">'/zappa.js'</span> <span class="hljs-keyword">then</span> send client
              <span class="hljs-keyword">when</span> zappa_prefix+<span class="hljs-string">'/jquery.js'</span> <span class="hljs-keyword">then</span> send jquery_minified
              <span class="hljs-keyword">when</span> zappa_prefix+<span class="hljs-string">'/sammy.js'</span> <span class="hljs-keyword">then</span> send sammy_minified
              <span class="hljs-keyword">else</span> next()
          <span class="hljs-keyword">return</span>
      <span class="hljs-attribute">partials</span>: <span class="hljs-function"><span class="hljs-params">(maps = {})</span> -&gt;</span>
        express_partials ?= <span class="hljs-built_in">require</span> <span class="hljs-string">'zappajs-partials'</span>
        partials = express_partials()
        partials.register <span class="hljs-string">'coffee'</span>, coffeecup_adapter.render
        <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> maps
          partials.register k, v
        partials
      <span class="hljs-attribute">session</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
        context.session_store = options.store
        express.session options
<span class="hljs-function">
    <span class="hljs-title">use</span> = <span class="hljs-params">(name, arg = <span class="hljs-literal">null</span>)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> zappa_middleware[name]
        app.use zappa_middleware[name](arg)
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> express[name] <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
        app.use use_middleware express[name](arg)
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-string">"Unknown middleware <span class="hljs-subst">#{name}</span>"</span>

    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> arguments
      <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> a
        <span class="hljs-keyword">when</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> app.use use_middleware a
        <span class="hljs-keyword">when</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> use a
        <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
          <span class="hljs-keyword">if</span> a.stack? <span class="hljs-keyword">or</span> a.route? <span class="hljs-keyword">or</span> a.handle?
            app.use a
          <span class="hljs-keyword">else</span>
            use k, v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> a
    <span class="hljs-keyword">return</span>

  context.c<span class="hljs-function"><span class="hljs-title">onfigure</span> = <span class="hljs-params">(p)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> p <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> app.configure p
    <span class="hljs-keyword">else</span> app.configure k, v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> p
    <span class="hljs-keyword">return</span>

  context.settings = app.settings
  context.locals = app.locals

  context.s<span class="hljs-function"><span class="hljs-title">hared</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    context.use <span class="hljs-string">'zappa'</span> <span class="hljs-keyword">unless</span> zappa_used
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      js = <span class="hljs-string">";zappa.run(<span class="hljs-subst">#{v}</span>);"</span>
      js = minify(js) <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'minify'</span>]
      route <span class="hljs-attribute">verb</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attribute">path</span>: k, <span class="hljs-attribute">handler</span>: js, <span class="hljs-attribute">contentType</span>: <span class="hljs-string">'js'</span>
      v.apply context
    <span class="hljs-keyword">return</span>

  context.i<span class="hljs-function"><span class="hljs-title">nclude</span> = <span class="hljs-params">(p)</span> -&gt;</span>
    sub = <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> p <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">require</span> path.join(real_root, p) <span class="hljs-keyword">else</span> p
    sub.include.apply context
<span class="hljs-function">
  <span class="hljs-title">apply_helpers</span> = <span class="hljs-params">(ctx)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> name, helper <span class="hljs-keyword">of</span> helpers
      <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(name, helper)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> helper <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
          ctx[name] =<span class="hljs-function"> -&gt;</span>
            helper.apply ctx, arguments
        <span class="hljs-keyword">else</span>
          ctx[name] = helper
        <span class="hljs-keyword">return</span>
    ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Local socket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">request_socket</span> = <span class="hljs-params">(req)</span> -&gt;</span>
    socket_id = req.session?.__socket?[<span class="hljs-string">'__local'</span>]?.id
    socket_id <span class="hljs-keyword">and</span> io?.sockets.socket socket_id, <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>The callback will receive (err,session).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">socket_session</span> = <span class="hljs-params">(socket,cb)</span> -&gt;</span>
    socket.get socketio_key, <span class="hljs-function"><span class="hljs-params">(err,data)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> err
        <span class="hljs-keyword">return</span> cb err
      data = JSON.parse data
      <span class="hljs-keyword">if</span> data.id?
        context.session_store.get data.id, cb
      <span class="hljs-keyword">else</span>
        cb err

  context.p<span class="hljs-function"><span class="hljs-title">aram</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
<span class="hljs-function">    <span class="hljs-title">build</span> = <span class="hljs-params">(callback)</span> -&gt;</span>
<span class="hljs-function">      <span class="hljs-params">(req,res,next,p)</span> -&gt;</span>
        ctx =
          <span class="hljs-attribute">app</span>: app
          <span class="hljs-attribute">settings</span>: app.settings
          <span class="hljs-attribute">locals</span>: res.locals
          <span class="hljs-attribute">request</span>: req
          <span class="hljs-attribute">req</span>: req
          <span class="hljs-attribute">query</span>: req.query
          <span class="hljs-attribute">params</span>: req.params
          <span class="hljs-attribute">body</span>: req.body
          <span class="hljs-attribute">session</span>: req.session
          <span class="hljs-attribute">response</span>: res
          <span class="hljs-attribute">res</span>: res
          <span class="hljs-attribute">next</span>: next
          <span class="hljs-attribute">param</span>: p
        apply_helpers ctx
        callback.call ctx, req, res, next, p

    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
      <span class="hljs-property">@app</span>.param k, build v

    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Register a route with express.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">route</span> = <span class="hljs-params">(r)</span> -&gt;</span>
    r.middleware ?= []</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Rewrite middleware</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    r.middleware = r.middleware.map wrap_middleware

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> r.handler <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
      app[r.verb] r.path, r.middleware, <span class="hljs-function"><span class="hljs-params">(req, res)</span> -&gt;</span>
        res.contentType r.contentType <span class="hljs-keyword">if</span> r.contentType?
        res.send r.handler
        <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">else</span>
      app[r.verb] r.path, r.middleware, <span class="hljs-function"><span class="hljs-params">(req, res, next)</span> -&gt;</span>
        ctx =
          <span class="hljs-attribute">app</span>: app
          <span class="hljs-attribute">settings</span>: app.settings
          <span class="hljs-attribute">locals</span>: res.locals
          <span class="hljs-attribute">request</span>: req
          <span class="hljs-attribute">req</span>: req
          <span class="hljs-attribute">query</span>: req.query
          <span class="hljs-attribute">params</span>: req.params
          <span class="hljs-attribute">body</span>: req.body
          <span class="hljs-attribute">session</span>: req.session
          <span class="hljs-attribute">response</span>: res
          <span class="hljs-attribute">res</span>: res
          <span class="hljs-attribute">next</span>: next
          <span class="hljs-attribute">send</span>:<span class="hljs-function"> -&gt;</span> res.send.apply res, arguments
          <span class="hljs-attribute">json</span>:<span class="hljs-function"> -&gt;</span> res.json.apply res, arguments
          <span class="hljs-attribute">jsonp</span>:<span class="hljs-function"> -&gt;</span> res.jsonp.apply res, arguments
          <span class="hljs-attribute">redirect</span>:<span class="hljs-function"> -&gt;</span> res.redirect.apply res, arguments
          <span class="hljs-attribute">format</span>:<span class="hljs-function"> -&gt;</span> res.format.apply res, arguments
          <span class="hljs-attribute">render</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> arguments[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span>
              render.apply @, arguments
            <span class="hljs-keyword">else</span>
              <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> arguments[<span class="hljs-number">0</span>]
                render.apply @, [k, v]
            <span class="hljs-keyword">return</span>
          <span class="hljs-attribute">emit</span>:<span class="hljs-function"> -&gt;</span>
            socket = request_socket req
            <span class="hljs-keyword">if</span> socket?
              <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> arguments[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span>
                socket.emit.apply socket, arguments
              <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> arguments[<span class="hljs-number">0</span>]
                  socket.emit.apply socket, [k, v]
            <span class="hljs-keyword">return</span>
<span class="hljs-function">
        <span class="hljs-title">render</span> = <span class="hljs-params">(name,opts = {},fn)</span> -&gt;</span>

          report = fn ? <span class="hljs-function"><span class="hljs-params">(err,html)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> err
              next err
            <span class="hljs-keyword">else</span>
              res.send html</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Make sure the second arg is an object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> opts <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
            fn = opts
            opts = {}

          <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'databag'</span>]
            opts.params = ctx.data

          <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> opts.postrender?
            postrender = report
          <span class="hljs-keyword">else</span>
<span class="hljs-function">            <span class="hljs-title">postrender</span> = <span class="hljs-params">(err, str)</span> -&gt;</span>
              <span class="hljs-keyword">if</span> err <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> report err</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Apply postrender before sending response.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              jsdom.env <span class="hljs-attribute">html</span>: str, <span class="hljs-attribute">src</span>: [jquery], <span class="hljs-attribute">done</span>: <span class="hljs-function"><span class="hljs-params">(err, <span class="hljs-built_in">window</span>)</span> -&gt;</span>
                <span class="hljs-keyword">if</span> err <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> report err
                ctx.<span class="hljs-built_in">window</span> = <span class="hljs-built_in">window</span>
                rendered = postrenders[opts.postrender].apply ctx, [<span class="hljs-built_in">window</span>.$]

                doctype = (<span class="hljs-built_in">window</span>.<span class="hljs-built_in">document</span>.doctype <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>) + <span class="hljs-string">"\n"</span>
                html = doctype + <span class="hljs-built_in">window</span>.<span class="hljs-built_in">document</span>.documentElement.outerHTML
                report <span class="hljs-literal">null</span>, html
              <span class="hljs-keyword">return</span>

          res.render.call res, name, opts, postrender

        apply_helpers ctx

        <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'databag'</span>]
          ctx.data = {}
          copy_data_to ctx.data, [req.query, req.params, req.body]

        <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'x-powered-by'</span>]
          res.setHeader <span class="hljs-string">'X-Powered-By'</span>, <span class="hljs-string">"Zappa <span class="hljs-subst">#{zappa.version}</span>"</span>

        result = r.handler.call ctx, req, res, next

        res.contentType(r.contentType) <span class="hljs-keyword">if</span> r.contentType?
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> result <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> res.send result
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> result</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Register socket.io handlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  io?.sockets.<span class="hljs-literal">on</span> <span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-params">(socket)</span> -&gt;</span>
    c = {}
<span class="hljs-function">
    <span class="hljs-title">build_ctx</span> = -&gt;</span>
      ctx =
        <span class="hljs-attribute">app</span>: app
        <span class="hljs-attribute">io</span>: io
        <span class="hljs-attribute">settings</span>: app.settings
        <span class="hljs-attribute">locals</span>: app.locals
        <span class="hljs-attribute">socket</span>: socket
        <span class="hljs-attribute">id</span>: socket.id
        <span class="hljs-attribute">client</span>: c
        <span class="hljs-attribute">join</span>: <span class="hljs-function"><span class="hljs-params">(room)</span> -&gt;</span>
          socket.join room
        <span class="hljs-attribute">leave</span>: <span class="hljs-function"><span class="hljs-params">(room)</span> -&gt;</span>
          socket.leave room
        <span class="hljs-attribute">emit</span>:<span class="hljs-function"> -&gt;</span>
          <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> arguments[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span>
            socket.emit.apply socket, arguments
          <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> arguments[<span class="hljs-number">0</span>]
              socket.emit.apply socket, [k, v]
          <span class="hljs-keyword">return</span>
        <span class="hljs-attribute">broadcast</span>:<span class="hljs-function"> -&gt;</span>
          broadcast = socket.broadcast
          <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> arguments[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span>
            broadcast.emit.apply broadcast, arguments
          <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> arguments[<span class="hljs-number">0</span>]
              broadcast.emit.apply broadcast, [k, v]
          <span class="hljs-keyword">return</span>
        <span class="hljs-attribute">broadcast_to</span>: <span class="hljs-function"><span class="hljs-params">(room, args...)</span> -&gt;</span>
          room = io.sockets.<span class="hljs-keyword">in</span> room
          <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span>
            room.emit.apply room, args
          <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> args[<span class="hljs-number">0</span>]
              room.emit.apply room, [k, v]
          <span class="hljs-keyword">return</span>
        <span class="hljs-attribute">session</span>:<span class="hljs-function"> -&gt;</span> socket_session socket, arguments...

      apply_helpers ctx
      ctx

    ctx = build_ctx()
    ws_handlers.connection.apply(ctx) <span class="hljs-keyword">if</span> ws_handlers.connection?

    socket.<span class="hljs-literal">on</span> <span class="hljs-string">'disconnect'</span>,<span class="hljs-function"> -&gt;</span>
      ctx = build_ctx()
      ws_handlers.disconnect.apply(ctx) <span class="hljs-keyword">if</span> ws_handlers.disconnect?

    <span class="hljs-keyword">for</span> name, h <span class="hljs-keyword">of</span> ws_handlers
      <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(name, h)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> name <span class="hljs-keyword">isnt</span> <span class="hljs-string">'connection'</span> <span class="hljs-keyword">and</span> name <span class="hljs-keyword">isnt</span> <span class="hljs-string">'disconnect'</span>
          socket.<span class="hljs-literal">on</span> name, <span class="hljs-function"><span class="hljs-params">(data, ack)</span> -&gt;</span>
            ctx = build_ctx()
            ctx.data = data
            ctx.ack = ack
            h.call ctx, data, ack
        <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Go!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  func.apply context</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>The stringified zappa client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  client = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./client'</span>).build(zappa.version, app.settings)
  client = <span class="hljs-string">";<span class="hljs-subst">#{coffeescript_helpers}</span>(<span class="hljs-subst">#{client}</span>)();"</span>
  client_bundle_simple =
    <span class="hljs-keyword">if</span> io?
      jquery + socketjs + client
    <span class="hljs-keyword">else</span>
      jquery + client
  client_bundled =
    <span class="hljs-keyword">if</span> io?
      jquery + socketjs + sammy + client
    <span class="hljs-keyword">else</span>
      jquery + sammy + client

  <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'minify'</span>]
    client = minify client
    client_bundle_simple = minify client_bundle_simple
    client_bundled = minify client_bundled

  <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'default layout'</span>]
    context.view <span class="hljs-attribute">layout</span>:<span class="hljs-function"> -&gt;</span>
<span class="hljs-function">      <span class="hljs-title">extension</span> = <span class="hljs-params">(path,ext)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> path.substr(-(ext.length)).toLowerCase() <span class="hljs-keyword">is</span> ext.toLowerCase()
          path
        <span class="hljs-keyword">else</span>
          path + ext
      doctype <span class="hljs-number">5</span>
      html <span class="hljs-function">-&gt;</span>
        head <span class="hljs-function">-&gt;</span>
          title <span class="hljs-property">@title</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@title</span>
          <span class="hljs-keyword">if</span> <span class="hljs-property">@scripts</span>
            <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-property">@scripts</span>
              script <span class="hljs-attribute">src</span>: extension s, <span class="hljs-string">'.js'</span>
          script(<span class="hljs-attribute">src</span>: extension <span class="hljs-property">@script</span>, <span class="hljs-string">'.js'</span>) <span class="hljs-keyword">if</span> <span class="hljs-property">@script</span>
          <span class="hljs-keyword">if</span> <span class="hljs-property">@stylesheets</span>
            <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-property">@stylesheets</span>
              link <span class="hljs-attribute">rel</span>: <span class="hljs-string">'stylesheet'</span>, <span class="hljs-attribute">href</span>: extension s, <span class="hljs-string">'.css'</span>
          link(<span class="hljs-attribute">rel</span>: <span class="hljs-string">'stylesheet'</span>, <span class="hljs-attribute">href</span>: extension <span class="hljs-property">@stylesheet</span>, <span class="hljs-string">'.css'</span>) <span class="hljs-keyword">if</span> <span class="hljs-property">@stylesheet</span>
          style <span class="hljs-property">@style</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@style</span>
        body <span class="hljs-property">@body</span>

  <span class="hljs-keyword">if</span> io?
    zappa_prefix = app.settings[<span class="hljs-string">'zappa_prefix'</span>]
    context.get zappa_prefix+<span class="hljs-string">'/socket/:channel_name/:socket_id'</span>,<span class="hljs-function"> -&gt;</span>
      <span class="hljs-keyword">if</span> <span class="hljs-property">@session</span>?
        channel_name = <span class="hljs-property">@params</span>.channel_name
        socket_id = <span class="hljs-property">@params</span>.socket_id

        <span class="hljs-property">@session</span>.__socket ?= {}

        <span class="hljs-keyword">if</span> <span class="hljs-property">@session</span>.__socket[channel_name]?</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Client (or hijacker) trying to re-key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@send</span> <span class="hljs-attribute">error</span>:<span class="hljs-string">'Channel already assigned'</span>, <span class="hljs-attribute">channel_name</span>: channel_name
        <span class="hljs-keyword">else</span>
          key = uuid.v4() <span class="hljs-comment"># used for socket 'authorization'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Update the Express session store</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@session</span>.__socket[channel_name] =
            <span class="hljs-attribute">id</span>: socket_id
            <span class="hljs-attribute">key</span>: key</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Update the Socket.IO store</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          io_client = io.sockets.store.client(socket_id)
          io_data = JSON.stringify
            <span class="hljs-attribute">id</span>: <span class="hljs-property">@req</span>.sessionID
            <span class="hljs-attribute">key</span>: key
          io_client.set socketio_key, io_data</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Let the client know which key to use.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@send</span> <span class="hljs-attribute">channel_name</span>: channel_name, <span class="hljs-attribute">key</span>: key
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@send</span> <span class="hljs-attribute">error</span>:<span class="hljs-string">'No session'</span>
      <span class="hljs-keyword">return</span>

  context</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>zappa.run [host,] [port,] [{options},] root_function
Takes a function and runs it as a zappa app. Optionally accepts a port
number, and/or a hostname (any order). The hostname must be a string, and
the port number must be castable as a number.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
zappa.r<span class="hljs-function"><span class="hljs-title">un</span> = -&gt;</span>
  host = <span class="hljs-literal">null</span>
  port = <span class="hljs-number">3000</span>
  root_function = <span class="hljs-literal">null</span>
  options =
    <span class="hljs-attribute">disable_io</span>: <span class="hljs-literal">false</span>

  <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> arguments
    <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'string'</span>
        <span class="hljs-keyword">if</span> isNaN( (Number) a ) <span class="hljs-keyword">then</span> host = a
        <span class="hljs-keyword">else</span> port = (Number) a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">then</span> port = a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> root_function = a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> a
          <span class="hljs-keyword">switch</span> k
            <span class="hljs-keyword">when</span> <span class="hljs-string">'host'</span> <span class="hljs-keyword">then</span> host = v
            <span class="hljs-keyword">when</span> <span class="hljs-string">'port'</span> <span class="hljs-keyword">then</span> port = v
            <span class="hljs-keyword">else</span> options[k] = v

  zapp = zappa.app(root_function,options)
  app = zapp.app
<span class="hljs-function">
  <span class="hljs-title">express_ready</span> = -&gt;</span>
    log <span class="hljs-string">'Express server listening on port %d in %s mode'</span>,
      zapp.server.address()?.port, app.settings.env
    log <span class="hljs-string">"Zappa <span class="hljs-subst">#{zappa.version}</span> \"<span class="hljs-subst">#{codename}</span>\" orchestrating the show"</span>

  <span class="hljs-keyword">if</span> host
    zapp.server.listen port, host, express_ready
  <span class="hljs-keyword">else</span>
    zapp.server.listen port, express_ready

  zapp</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Creates a zappa view adapter for templating engine <code>engine</code>. This adapter
can be used with <code>context.engine</code> or <code>context.use partials:</code>
and creates params “shortcuts”.</p>
<p>Zappa, by default, automatically sends all request params to templates,
but inside the <code>params</code> local.</p>
<p>This adapter adds a “root local” for each of these params, <em>only</em>
if a local with the same name doesn’t exist already, <em>and</em> the name is not
in the optional blacklist.</p>
<p>The blacklist is useful to prevent request params from triggering unset
template engine options.</p>
<p>If <code>engine</code> is a string, the adapter will use <code>require(engine)</code>. Otherwise,
it will assume the <code>engine</code> param is an object with a <code>compile</code> function.</p>
<p>Return an Express 2.x as well as an Express 3.x compatible object.
The Express 2.x object supports both <code>compile</code> and <code>render</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>zappa.a<span class="hljs-function"><span class="hljs-title">dapter</span> = <span class="hljs-params">(engine, options = {})</span> -&gt;</span>
  options.blacklist ?= []
  engine = <span class="hljs-built_in">require</span>(engine) <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> engine <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
<span class="hljs-function">  <span class="hljs-title">compile</span> = <span class="hljs-params">(template, data)</span> -&gt;</span>
    template = engine.compile(template, data)
<span class="hljs-function">    <span class="hljs-params">(data)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Merge down <code>@params</code> into <code>@</code>
Bonus: if <code>databag</code> is enabled, <code>@params</code> will be the complete databag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> data.params
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> data[k] <span class="hljs-keyword">is</span> <span class="hljs-string">'undefined'</span> <span class="hljs-keyword">and</span> k <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> options.blacklist
          data[k] = v
      template(data)
<span class="hljs-function">  <span class="hljs-title">render</span> = <span class="hljs-params">(template,data)</span> -&gt;</span>
    template = compile template, data
    template data</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Express 3.x object:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">renderFile</span> = <span class="hljs-params">(name,data,fn)</span> -&gt;</span>
    <span class="hljs-keyword">try</span>
      template = fs.readFileSync(name,<span class="hljs-string">'utf8'</span>)
      template = compile template, data
    <span class="hljs-keyword">catch</span> err
      <span class="hljs-keyword">return</span> fn err
    fn <span class="hljs-literal">null</span>, template data</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Express 2.x extensions:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  renderFile.compile = compile
  renderFile.render = render
  renderFile

zappa.install_fs = install_zappa_fs

coffeecup_adapter = zappa.adapter <span class="hljs-string">'coffeecup'</span>,
  <span class="hljs-attribute">blacklist</span>: [<span class="hljs-string">'format'</span>, <span class="hljs-string">'autoescape'</span>, <span class="hljs-string">'locals'</span>, <span class="hljs-string">'hardcode'</span>, <span class="hljs-string">'cache'</span>]

<span class="hljs-built_in">module</span>.exports = zappa.run
<span class="hljs-built_in">module</span>.exports.run = zappa.run
<span class="hljs-built_in">module</span>.exports.app = zappa.app
<span class="hljs-built_in">module</span>.exports.adapter = zappa.adapter
<span class="hljs-built_in">module</span>.exports.version = zappa.version</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
